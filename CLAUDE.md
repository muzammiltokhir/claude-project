# CLAUDE.md - Claude Code Instructions

This file contains instructions for Claude Code to properly build, test, and deploy the Firebase Cloud Functions API project.

## ğŸ—ï¸ Project Overview

- **Project Type**: Firebase Cloud Functions with TypeScript and Express.js
- **Project ID**: `public-api-37564`
- **Main Function**: `api` (exported from src/index.ts)
- **Language**: TypeScript
- **Framework**: Express.js with Firebase Functions

## ğŸ“‹ Build Commands

### Install Dependencies
```bash
npm install
```

### Build TypeScript
```bash
npm run build
```

### Start Local Development (Firebase Emulators)
```bash
npm run serve
```

### Deploy to Firebase
```bash
npm run deploy
```

### View Function Logs
```bash
npm run logs
```

## ğŸ§ª Testing Commands

### Local Testing URLs
- **Functions Emulator**: `http://localhost:5001/public-api-37564/us-central1/api`
- **Health Check**: `http://localhost:5001/public-api-37564/us-central1/api/`
- **Swagger Docs**: `http://localhost:5001/public-api-37564/us-central1/api/docs`

### Production URLs
- **Functions**: `https://us-central1-public-api-37564.cloudfunctions.net/api`
- **Swagger Docs**: `https://us-central1-public-api-37564.cloudfunctions.net/api/docs`

## ğŸ”§ Development Workflow

### 1. Environment Setup
```bash
# Set up Firebase service account for local development
export GOOGLE_APPLICATION_CREDENTIALS="path/to/serviceAccountKey.json"

# Or use Firebase login
firebase login
```

### 2. Install Dependencies
```bash
npm install
```

### 3. Start Development Server
```bash
npm run serve
```

### 4. Test Endpoints
```bash
# Health check
curl http://localhost:5001/public-api-37564/us-central1/api/

# Test public endpoint (requires Firestore setup)
curl -X GET http://localhost:5001/public-api-37564/us-central1/api/api/public \
  -H "x-access-code: test-access-code"

# Test private endpoint (requires Firebase Auth token)
curl -X GET http://localhost:5001/public-api-37564/us-central1/api/api/private \
  -H "Authorization: Bearer YOUR_FIREBASE_ID_TOKEN"
```

## ğŸš€ Deployment Process

### Pre-deployment Checklist
1. âœ… Build successful: `npm run build`
2. âœ… TypeScript compilation: Check `lib/` directory exists
3. âœ… Firebase project configured: `.firebaserc` exists with correct project ID
4. âœ… Environment variables set (if any)

### Deploy Commands
```bash
# Build first
npm run build

# Deploy functions only
firebase deploy --only functions

# Deploy everything (functions + hosting)
firebase deploy

# Deploy specific function
firebase deploy --only functions:api
```

## ğŸ“Š API Documentation

### Swagger/OpenAPI
- **Local**: `http://localhost:5001/public-api-37564/us-central1/api/docs`
- **Production**: `https://us-central1-public-api-37564.cloudfunctions.net/api/docs`

### Available Endpoints

| Method | Endpoint | Auth Required | Description |
|--------|----------|---------------|-------------|
| GET | `/` | None | Health check |
| GET | `/docs` | None | Swagger documentation |
| GET | `/api/public` | Company Access Code | Public data endpoint |
| POST | `/api/public/data` | Company Access Code | Submit data to public endpoint |
| GET | `/api/private` | Firebase Auth | Private data endpoint |
| GET | `/api/private/profile` | Firebase Auth | User profile endpoint |

## ğŸ”‘ Authentication Setup

### Company Access Codes (Firestore)
Create documents in `companies` collection:
```javascript
{
  "name": "Test Company",
  "accessCode": "test-access-code",
  "isActive": true,
  "createdAt": firestore.Timestamp.now(),
  "updatedAt": firestore.Timestamp.now()
}
```

### Firebase Authentication
Users need valid Firebase ID tokens from Firebase Auth.

## ğŸ› ï¸ Troubleshooting

### Common Issues & Solutions

#### Build Errors
```bash
# Clear node_modules and reinstall
rm -rf node_modules package-lock.json
npm install
npm run build
```

#### TypeScript Errors
```bash
# Check TypeScript configuration
npx tsc --noEmit
```

#### Firebase Deployment Issues
```bash
# Check Firebase project
firebase projects:list
firebase use public-api-37564

# Check Firebase functions status
firebase functions:list
```

#### Local Emulator Issues
```bash
# Start emulators with debug info
firebase emulators:start --debug

# Kill any running emulators
pkill -f firebase
```

### Environment Variables
- `GOOGLE_APPLICATION_CREDENTIALS`: Path to Firebase service account key
- `FIREBASE_CONFIG`: Automatically set by Firebase Functions runtime

### File Structure Check
```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ firebase.ts
â”‚   â”‚   â””â”€â”€ swagger.ts
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ auth.ts
â”‚   â”œâ”€â”€ types.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ lib/                    # Generated by TypeScript build
â”œâ”€â”€ .firebaserc            # Firebase project configuration
â”œâ”€â”€ firebase.json          # Firebase configuration
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## ğŸ“ Code Quality

### TypeScript Compilation
```bash
# Check for TypeScript errors
npx tsc --noEmit

# Build and check output
npm run build
ls -la lib/
```

### Code Style
- Follow existing TypeScript conventions
- Use async/await for asynchronous operations
- Implement proper error handling
- Add JSDoc comments for Swagger documentation

## ğŸš¨ Important Notes

1. **Always build before deploying**: `npm run build`
2. **Test locally first**: Use Firebase emulators
3. **Check logs for errors**: `npm run logs`
4. **Monitor Firestore usage**: Company access codes are stored in Firestore
5. **Swagger docs are available**: Use `/docs` endpoint for API documentation
6. **Authentication is required**: Set up proper Firebase Auth and Firestore data

## ğŸ”„ Quick Testing Script

```bash
#!/bin/bash
# Quick test script

echo "Building project..."
npm run build

echo "Starting emulators..."
npm run serve &
EMULATOR_PID=$!

# Wait for emulators to start
sleep 10

echo "Testing health endpoint..."
curl -s http://localhost:5001/public-api-37564/us-central1/api/ | jq .

echo "Testing Swagger docs..."
curl -s http://localhost:5001/public-api-37564/us-central1/api/docs | head -10

# Stop emulators
kill $EMULATOR_PID

echo "Tests completed!"
```

## ğŸ“š Additional Resources

- [Firebase Functions Documentation](https://firebase.google.com/docs/functions)
- [TypeScript Firebase Functions Guide](https://firebase.google.com/docs/functions/typescript)
- [Express.js Documentation](https://expressjs.com/)
- [Swagger/OpenAPI Specification](https://swagger.io/specification/)